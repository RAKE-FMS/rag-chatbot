name: cd-dev

on:
    push:
        branches: [main]
        paths:
            - "infra/**"
            - "apps/**"

permissions:
    id-token: write
    contents: read

jobs:
    changes:
        name: "cd: detect changes"
        runs-on: ubuntu-latest
        outputs:
            search: ${{ steps.filter.outputs.search }}
            chat-api: ${{ steps.filter.outputs.chat-api }}
            chat-web: ${{ steps.filter.outputs.chat-web }}
        steps:
            - uses: actions/checkout@v4
            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      search:
                          - 'apps/search/**'
                      chat-api:
                          - 'apps/chat-api/**'
                      chat-web:
                          - 'apps/chat-web/**'

    infra-deploy:
        name: "infra: deploy"
        runs-on: ubuntu-latest
        environment: dev
        outputs:
            AZURE_CHAT_API_FUNC_NAME: ${{ steps.deploy.outputs.chatApiFuncName }}
            AZURE_SEARCH_NAME: ${{ steps.deploy.outputs.searchName }}
            AZURE_OPENAI_NAME: ${{ steps.deploy.outputs.openaiName }}
            AZURE_TEXT_EMBEDDING_3_SMALL_NAME: ${{ steps.deploy.outputs.textEmbedding3SmallName }}
            AZURE_DOCS_ST_NAME: ${{ steps.deploy.outputs.docsStName }}
            AZURE_CHAT_WEB_STAPP_NAME: ${{ steps.deploy.outputs.chatWebStappName }}
            AZURE_CHAT_API_DEFAULT_HOST_NAME: ${{ steps.deploy.outputs.chatApiDefaultHostName }}
        steps:
            - name: "checkout"
              uses: actions/checkout@v4

            - name: "login azure"
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: "deploy bicep"
              id: deploy
              uses: azure/arm-deploy@v2
              with:
                  resourceGroupName: ${{ vars.AZURE_RESOURCE_GROUP_NAME }}
                  template: infra/main.bicep
                  parameters: infra/params/dev.bicepparam

    search-apply:
        name: "search: apply"
        needs:
            - changes
            - infra-deploy
        if: ${{ needs.changes.outputs.search == 'true' }}
        runs-on: ubuntu-latest
        environment: dev
        steps:
            - name: "checkout"
              uses: actions/checkout@v4

            - name: "login azure"
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: "setup node"
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: "apps/search/package-lock.json"

            - name: "install search scripts"
              run: |
                  npm ci --prefix apps/search

            - name: "apply search schemas"
              env:
                  AZURE_RESOURCE_GROUP_NAME: ${{ vars.AZURE_RESOURCE_GROUP_NAME }}
                  AZURE_SEARCH_NAME: ${{ needs.infra-deploy.outputs.AZURE_SEARCH_NAME }}
                  AZURE_OPENAI_NAME: ${{ needs.infra-deploy.outputs.AZURE_OPENAI_NAME }}
                  AZURE_TEXT_EMBEDDING_3_SMALL_NAME: ${{ needs.infra-deploy.outputs.AZURE_TEXT_EMBEDDING_3_SMALL_NAME }}
                  AZURE_DOCS_ST_NAME: ${{ needs.infra-deploy.outputs.AZURE_DOCS_ST_NAME }}
              run: |
                  set -euo pipefail

                  AZURE_SEARCH_SERVICE_ENDPOINT="https://${AZURE_SEARCH_NAME}.search.windows.net"
                  AZURE_SEARCH_ADMIN_KEY="$(az search admin-key show -g "${AZURE_RESOURCE_GROUP_NAME}" --service-name "${AZURE_SEARCH_NAME}" --query primaryKey -o tsv)"
                  AZURE_OPENAI_ENDPOINT="$(az cognitiveservices account show -g "${AZURE_RESOURCE_GROUP_NAME}" -n "${AZURE_OPENAI_NAME}" --query properties.endpoint -o tsv)"
                  AZURE_OPENAI_API_KEY="$(az cognitiveservices account keys list -g "${AZURE_RESOURCE_GROUP_NAME}" -n "${AZURE_OPENAI_NAME}" --query key1 -o tsv)"
                  AZURE_DOCS_STORAGE_KEY="$(az storage account keys list -g "${AZURE_RESOURCE_GROUP_NAME}" -n "${AZURE_DOCS_ST_NAME}" --query '[0].value' -o tsv)"
                  AZURE_DOCS_STORAGE_CONNECTION_STRING="DefaultEndpointsProtocol=https;AccountName=${AZURE_DOCS_ST_NAME};AccountKey=${AZURE_DOCS_STORAGE_KEY};EndpointSuffix=core.windows.net"

                  export AZURE_SEARCH_SERVICE_ENDPOINT
                  export AZURE_SEARCH_ADMIN_KEY
                  export AZURE_OPENAI_ENDPOINT
                  export AZURE_OPENAI_API_KEY
                  export AZURE_OPENAI_TEXT_EMBEDDING_3_SMALL_DEPLOYMENT="${AZURE_TEXT_EMBEDDING_3_SMALL_NAME}"
                  export AZURE_DOCS_STORAGE_CONNECTION_STRING

                  npm run apply --prefix apps/search

    chat-api-deploy:
        name: "chat-api: deploy"
        needs:
            - changes
            - infra-deploy
        if: ${{ needs.changes.outputs.chat-api == 'true' }}
        runs-on: ubuntu-latest
        environment: dev
        steps:
            - name: "checkout"
              uses: actions/checkout@v4

            - name: "login azure"
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: "setup node"
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: "apps/chat-api/package-lock.json"

            - name: "install and build"
              run: |
                  cd apps/chat-api
                  npm install
                  npm run build --if-present

            - name: "deploy function"
              uses: azure/functions-action@v1
              with:
                  app-name: ${{ needs.infra-deploy.outputs.AZURE_CHAT_API_FUNC_NAME }}
                  package: "apps/chat-api"

    chat-web-deploy:
        name: "chat-web: deploy"
        needs:
            - changes
            - infra-deploy
        if: ${{ needs.changes.outputs.chat-web == 'true' }}
        runs-on: ubuntu-latest
        environment: dev
        steps:
            - name: "checkout"
              uses: actions/checkout@v4

            - name: "login azure"
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: "get static web app deploy token"
              id: get_swa_token
              env:
                  AZURE_RESOURCE_GROUP_NAME: ${{ vars.AZURE_RESOURCE_GROUP_NAME }}
                  AZURE_CHAT_WEB_STAPP_NAME: ${{ needs.infra-deploy.outputs.AZURE_CHAT_WEB_STAPP_NAME }}
              run: |
                  set -euo pipefail
                  TOKEN="$(az staticwebapp secrets list \
                    --name "${AZURE_CHAT_WEB_STAPP_NAME}" \
                    --resource-group "${AZURE_RESOURCE_GROUP_NAME}" \
                    --query properties.apiKey \
                    -o tsv)"
                  echo "token=${TOKEN}" >> "$GITHUB_OUTPUT"

            - name: "deploy static web app"
              uses: Azure/static-web-apps-deploy@v1
              env:
                  VITE_API_BASE_URL: "https://${{ needs.infra-deploy.outputs.AZURE_CHAT_API_DEFAULT_HOST_NAME }}/api"
              with:
                  azure_static_web_apps_api_token: ${{ steps.get_swa_token.outputs.token }}
                  action: "upload"
                  app_location: "apps/chat-web"
                  output_location: "dist"